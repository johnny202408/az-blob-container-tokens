1# Azure Blob Storage with SAS Tokens Terraform Module

This Terraform configuration provisions an Azure Blob Storage environment including a storage account, a private blob container, and generates SAS tokens with specific permissions. The SAS tokens are saved as local files for secure use.

## Features

- Uses the AzureRM provider for resource provisioning.
- Creates or references an existing Resource Group.
- Creates a Storage Account with blob versioning and change feed enabled.
- Creates a private Blob Container within the Storage Account.
- Generates two SAS tokens for the Blob Container:
  - **Write SAS Token:** Allows add, create, and write permissions.
  - **Read/Delete SAS Token:** Allows read, list, and delete permissions.
- SAS tokens have configurable expiry duration.
- Saves SAS tokens to local text files for easy access.
- Outputs relevant resource names, keys, endpoints, and SAS tokens.

## Prerequisites

- Terraform version that supports required providers (azurerm ~> 3.0, time ~> 0.9).
- Azure account with sufficient permissions to create or manage resource groups and storage accounts.
- Optional: An existing Resource Group with the specified name or uncomment resource group creation block.

## Usage

1. Clone or download this Terraform configuration.
2. Adjust Terraform variables as needed (see below).
3. Initialize Terraform:

```bash
terraform init
```

4. Plan the deployment:

```bash
terraform plan
```

5. Apply the configuration:

```bash
terraform apply
```

6. After completion, SAS tokens and resource information will be output and SAS tokens saved as local text files.

## Configuration Variables

| Variable               | Description                        | Default          |
|------------------------|----------------------------------|------------------|
| `resource_group_name`   | Name of the Azure resource group | `rg-blob-container`         |
| `location`             | Azure region/location             | `eastus`    |
| `storage_account_name`  | Storage account name (3-24 lowercase letters/numbers) | `stgblobtgi0001` |
| `container_name`        | Blob container name               | `blob-container-001` |
| `sas_expiry_days`       | Days until SAS token expiration   | `60`             |

## Outputs

- `resource_group_name`: Name of the referenced resource group.
- `storage_account_name`: Created storage account name.
- `storage_account_primary_key`: Storage account primary access key (sensitive).
- `container_name`: Created blob container name.
- `write_sas_token`: SAS token with write permissions (sensitive).
- `read_delete_sas_token`: SAS token with read and delete permissions (sensitive).
- `storage_account_blob_endpoint`: Primary blob service endpoint URL.
- `container_url`: Full URL of the blob container.
- `write_sas_file_path`: Path to local file containing the write SAS token.
- `read_delete_sas_file_path`: Path to local file containing the read/delete SAS token.

## Notes

- The resource group creation block is commented out; modify as needed to create a new resource group.
- The storage account name must be 3 to 24 lowercase letters and numbers.
- The blob container access type is private.
- SAS tokens are time-limited based on the configurable expiry duration.
- Blob versioning and change feed are enabled for better blob lifecycle management.


## Testing SAS Tokens with Python

This repository includes a Python unittest script to validate the generated SAS tokens by performing a full lifecycle on a test blob:

1. Uploads a blob using the **write** SAS token.
2. Reads and verifies the blob content using the **read/delete** SAS token.
3. Deletes the blob using the **read/delete** SAS token.
4. Confirms the blob deletion by expecting a download failure.

### Prerequisites

- Python 3 with `azure-storage-blob` package installed:

```bash
pip install azure-storage-blob
```

- The SAS token files (`write_sas_token.txt` and `read_delete_sas_token.txt`) generated by Terraform must be present in the same directory.
- Update the `account_name` and `container_name` in the script if different from defaults.

### Running the Test

Execute the test script with:

```bash
python3 test_sas_tokens.py
```

Successful run indicates that the SAS tokens have appropriate permissions and work as expect

## License

This project is licensed under the MIT License.
This README covers purpose, usage, variables, outputs, and important notes on the Terraform code for easy onboarding and documentation completeness. Let me know if more sections or details are needed.